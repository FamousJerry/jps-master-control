<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jingjai Productions Master Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #141414; font-family: 'Inter', sans-serif; color: #fff; }
        .logo-neon { color: #39FF14; text-shadow: 0 0 2px #39FF14, 0 0 8px #39FF14, 0 0 15px #1c7a0a; }
        .action-button { background-color: #2d9e1c; transition: background-color 0.3s; }
        .action-button:hover { background-color: #39FF14; color: #141414; }
        #mainNav a.active-nav { color: #39FF14; font-weight: 700; }
        .form-input { background-color: #333; border: 1px solid #555; border-radius: 4px; padding: 12px 16px; width: 100%; color: #fff; transition: border-color 0.3s; }
        .form-input:focus { outline: none; border-color: #39FF14; }
        .module-card { background-color: #2F2F2F; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .module-card:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .hidden-view { display: none; }
        .modal { background-color: rgba(0,0,0,0.75); }
        .modal-content { background-color: #181818; }
    </style>
</head>
<body>

    <div id="app-container">

        <!-- LOGIN VIEW -->
        <div id="login-view" class="flex items-center justify-center min-h-screen">
            <div class="w-full max-w-md p-8 space-y-8 rounded-lg" style="background-color: rgba(0, 0, 0, 0.8);">
                <div class="text-center">
                    <h1 class="text-3xl font-bold logo-neon mb-2">Jingjai Productions</h1>
                    <h2 class="text-2xl font-semibold">Master Control Login</h2>
                </div>
                <form id="login-form" class="space-y-6">
                    <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
                    <input id="login-email" type="email" required class="form-input" placeholder="Email address">
                    <input id="login-password" type="password" required class="form-input" placeholder="Password">
                    <button type="submit" class="w-full flex justify-center py-3 px-4 rounded-md text-sm font-bold text-white action-button">Sign in</button>
                </form>
            </div>
        </div>

        <!-- MAIN APPLICATION VIEW -->
        <div id="main-app-view" class="hidden-view">
            <header class="fixed top-0 left-0 right-0 bg-black z-50 p-4 md:px-8 flex justify-between items-center">
                <div class="flex items-center space-x-4 md:space-x-8">
                    <h1 class="text-lg md:text-2xl font-bold logo-neon whitespace-nowrap">
                        <span class="hidden md:inline">Jingjai Productions Master Control</span>
                        <span class="md:hidden">JP Master Control</span>
                    </h1>
                    <nav id="mainNav" class="hidden md:flex space-x-4">
                        <a href="#" data-view="dashboard-view" class="nav-link text-white font-semibold hover:text-gray-300 active-nav">Dashboard</a>
                        <a href="#" data-view="client-central-view" class="nav-link text-white font-semibold hover:text-gray-300">Client Central</a>
                        <a href="#" data-view="inventory-view" class="nav-link text-white font-semibold hover:text-gray-300">Inventory</a>
                        <a href="#" data-view="sales-view" class="nav-link text-white font-semibold hover:text-gray-300">Sales</a>
                        <a href="#" data-view="scheduling-view" class="nav-link text-white font-semibold hover:text-gray-300">Scheduling</a>
                        <a href="#" data-view="admin-view" id="admin-nav-link" class="nav-link text-white font-semibold hover:text-gray-300 hidden">Admin</a>
                    </nav>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p id="user-display-name" class="font-semibold"></p>
                        <p id="user-display-role" class="text-xs text-gray-400"></p>
                    </div>
                    <button id="logout-button" class="text-xs text-gray-400 hover:text-white">Logout</button>
                </div>
            </header>

            <main class="pt-24 px-4 md:px-8">
                <div id="module-container">
                    
                    <!-- Dashboard View -->
                    <div id="dashboard-view" class="module-view">
                        <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                           <div class="module-card p-4 rounded-lg cursor-pointer" data-view="client-central-view"><h3 class="font-bold text-lg">Client Central</h3><p class="text-sm text-gray-400">Manage clients and leads.</p></div>
                           <div class="module-card p-4 rounded-lg cursor-pointer" data-view="inventory-view"><h3 class="font-bold text-lg">Inventory</h3><p class="text-sm text-gray-400">Track equipment and stock.</p></div>
                           <div class="module-card p-4 rounded-lg cursor-pointer" data-view="sales-view"><h3 class="font-bold text-lg">Sales Quoting</h3><p class="text-sm text-gray-400">Create and send quotes.</p></div>
                           <div class="module-card p-4 rounded-lg cursor-pointer" data-view="scheduling-view"><h3 class="font-bold text-lg">Job Scheduling</h3><p class="text-sm text-gray-400">Coordinate your team.</p></div>
                        </div>
                    </div>

                    <!-- Client Central View -->
                    <div id="client-central-view" class="module-view hidden-view">
                        <h2 class="text-3xl font-bold mb-6">Client Central</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div class="md:col-span-1">
                                <h3 class="text-xl font-semibold mb-4">Add New Client</h3>
                                <form id="add-client-form" class="space-y-4">
                                    <input id="client-name" type="text" required class="form-input" placeholder="Client Name">
                                    <input id="client-contact" type="text" required class="form-input" placeholder="Primary Contact">
                                    <input id="client-email" type="email" required class="form-input" placeholder="Contact Email">
                                    <select id="client-status" class="form-input">
                                        <option>Lead</option><option>Active</option><option>On Hold</option><option>Archived</option>
                                    </select>
                                    <button type="submit" class="action-button font-bold py-2 px-4 rounded-md">Add Client</button>
                                </form>
                            </div>
                            <div class="md:col-span-2">
                                <h3 class="text-xl font-semibold mb-4">Current Clients</h3>
                                <div id="client-list" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory View -->
                    <div id="inventory-view" class="module-view hidden-view">
                        <h2 class="text-3xl font-bold mb-6">Inventory</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div class="md:col-span-1">
                                <h3 class="text-xl font-semibold mb-4">Add New Item</h3>
                                <form id="add-item-form" class="space-y-4">
                                    <input id="item-name" type="text" required class="form-input" placeholder="Item Name">
                                    <input id="item-category" type="text" required class="form-input" placeholder="Category (e.g., Camera, Audio)">
                                    <input id="item-quantity" type="number" required class="form-input" placeholder="Quantity">
                                    <select id="item-status" class="form-input">
                                        <option>Available</option><option>In Use</option><option>Maintenance</option><option>Retired</option>
                                    </select>
                                    <button type="submit" class="action-button font-bold py-2 px-4 rounded-md">Add Item</button>
                                </form>
                            </div>
                            <div class="md:col-span-2">
                                <h3 class="text-xl font-semibold mb-4">Current Stock</h3>
                                <div id="inventory-list" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>

                    <div id="sales-view" class="module-view hidden-view"><h2 class="text-3xl font-bold">Sales Quoting</h2><p class="text-gray-400 mt-4">This is where the Sales Quoting section will live.</p></div>
                    <div id="scheduling-view" class="module-view hidden-view"><h2 class="text-3xl font-bold">Job Scheduling</h2><p class="text-gray-400 mt-4">This is where the Job Scheduling section will live.</p></div>

                    <!-- Admin View -->
                    <div id="admin-view" class="module-view hidden-view">
                        <h2 class="text-3xl font-bold mb-6">Admin: User Management</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="text-xl font-semibold mb-4">Create New User</h3>
                                <form id="create-user-form" class="space-y-4">
                                    <div id="create-user-error" class="text-red-500 text-sm hidden"></div>
                                    <div id="create-user-success" class="text-green-500 text-sm hidden"></div>
                                    <input id="new-user-name" type="text" required class="form-input" placeholder="Full Name">
                                    <input id="new-user-email" type="email" required class="form-input" placeholder="Email Address">
                                    <input id="new-user-password" type="password" required class="form-input" placeholder="Password (min. 6 characters)">
                                    <select id="new-user-role" class="form-input"><option value="Team Member">Team Member</option><option value="Admin">Admin</option></select>
                                    <button type="submit" class="action-button font-bold py-2 px-4 rounded-md">Create User</button>
                                </form>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold mb-4">Current Users</h3>
                                <div id="user-list" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Edit Client Modal -->
    <div id="edit-client-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal"><div class="modal-content rounded-lg w-11/12 md:w-1/2 max-w-lg"><div class="p-6"><div class="flex justify-between items-start"><div><h3 class="text-2xl font-bold">Edit Client</h3><p id="modal-client-id" class="text-sm text-gray-400"></p></div><button id="close-edit-client-modal-btn" class="text-2xl">&times;</button></div><div class="my-4 border-t border-gray-700"></div><form id="edit-client-form" class="space-y-4"><input id="edit-client-id" type="hidden"><input id="edit-client-name" type="text" required class="form-input" placeholder="Client Name"><input id="edit-client-contact" type="text" required class="form-input" placeholder="Primary Contact"><input id="edit-client-email" type="email" required class="form-input" placeholder="Contact Email"><select id="edit-client-status" class="form-input"><option>Lead</option><option>Active</option><option>On Hold</option><option>Archived</option></select><div class="flex justify-between items-center pt-4"><button id="delete-client-btn" type="button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Delete</button><button type="submit" class="action-button font-bold py-2 px-4 rounded-md">Save Changes</button></div></form></div></div></div>
    
    <!-- Edit Inventory Item Modal -->
    <div id="edit-item-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal"><div class="modal-content rounded-lg w-11/12 md:w-1/2 max-w-lg"><div class="p-6"><div class="flex justify-between items-start"><div><h3 class="text-2xl font-bold">Edit Item</h3><p id="modal-item-id" class="text-sm text-gray-400"></p></div><button id="close-edit-item-modal-btn" class="text-2xl">&times;</button></div><div class="my-4 border-t border-gray-700"></div><form id="edit-item-form" class="space-y-4"><input id="edit-item-id" type="hidden"><input id="edit-item-name" type="text" required class="form-input" placeholder="Item Name"><input id="edit-item-category" type="text" required class="form-input" placeholder="Category"><input id="edit-item-quantity" type="number" required class="form-input" placeholder="Quantity"><select id="edit-item-status" class="form-input"><option>Available</option><option>In Use</option><option>Maintenance</option><option>Retired</option></select><div class="flex justify-between items-center pt-4"><button id="delete-item-btn" type="button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Delete</button><button type="submit" class="action-button font-bold py-2 px-4 rounded-md">Save Changes</button></div></form></div></div></div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyABNyyrjBNTHc0LCV3nauqdTCsp-1blXAo",
            authDomain: "jps-app-468911.firebaseapp.com",
            projectId: "jps-app-468911",
            storageBucket: "jps-app-468911.appspot.com",
            messagingSenderId: "532726782263",
            appId: "1:532726782263:web:0e227d27bc61ef719962b2",
            measurementId: "G-8HXP33E0S8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM ELEMENTS ---
        const loginView = document.getElementById('login-view');
        const mainAppView = document.getElementById('main-app-view');
        const adminNavLink = document.getElementById('admin-nav-link');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const userDisplayName = document.getElementById('user-display-name');
        const userDisplayRole = document.getElementById('user-display-role');
        const mainNav = document.getElementById('mainNav');
        const createUserForm = document.getElementById('create-user-form');
        const userList = document.getElementById('user-list');
        // Client Elements
        const addClientForm = document.getElementById('add-client-form');
        const clientList = document.getElementById('client-list');
        const editClientModal = document.getElementById('edit-client-modal');
        const editClientForm = document.getElementById('edit-client-form');
        const closeEditClientModalBtn = document.getElementById('close-edit-client-modal-btn');
        const deleteClientBtn = document.getElementById('delete-client-btn');
        const modalClientId = document.getElementById('modal-client-id');
        // Inventory Elements
        const addItemForm = document.getElementById('add-item-form');
        const inventoryList = document.getElementById('inventory-list');
        const editItemModal = document.getElementById('edit-item-modal');
        const editItemForm = document.getElementById('edit-item-form');
        const closeEditItemModalBtn = document.getElementById('close-edit-item-modal-btn');
        const deleteItemBtn = document.getElementById('delete-item-btn');
        const modalItemId = document.getElementById('modal-item-id');
        
        // --- AUTH & ROLE CHECK ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    userDisplayName.textContent = userData.name;
                    userDisplayRole.textContent = userData.role;
                    if (userData.role === 'Admin') adminNavLink.classList.remove('hidden');
                    else adminNavLink.classList.add('hidden');
                }
                loginView.style.display = 'none';
                mainAppView.style.display = 'block';
                listenForUsers();
                listenForClients();
                listenForInventory();
            } else {
                loginView.style.display = 'flex';
                mainAppView.style.display = 'none';
            }
        });

        // --- LOGIN/LOGOUT ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value)
                .catch((error) => alert("Error: " + error.message));
        });
        logoutButton.addEventListener('click', () => signOut(auth));

        // --- USER MANAGEMENT (ADMIN ONLY) ---
        createUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const { 'new-user-name': name, 'new-user-email': email, 'new-user-password': password, 'new-user-role': role } = createUserForm.elements;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email.value, password.value);
                await setDoc(doc(db, "users", userCredential.user.uid), { name: name.value, email: email.value, role: role.value });
                alert(`Successfully created user: ${name.value}`);
                createUserForm.reset();
            } catch (error) {
                alert("Error: " + error.message);
            }
        });

        function listenForUsers() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                userList.innerHTML = '';
                snapshot.forEach((doc) => {
                    const userData = doc.data();
                    const userElement = document.createElement('div');
                    userElement.className = 'bg-gray-700 p-2 rounded flex justify-between items-center';
                    userElement.innerHTML = `<div><p class="font-semibold">${userData.name}</p><p class="text-xs text-gray-400">${userData.email} - ${userData.role}</p></div>`;
                    userList.appendChild(userElement);
                });
            });
        }
        
        // --- SEQUENTIAL ID GENERATOR ---
        async function getNextSequenceValue(sequenceName) {
            const counterRef = doc(db, "counters", sequenceName);
            let nextId;
            await runTransaction(db, async (transaction) => {
                const counterDoc = await transaction.get(counterRef);
                if (!counterDoc.exists()) {
                    // If counter doesn't exist, start it at 100000
                    nextId = 100001;
                    transaction.set(counterRef, { current_value: nextId });
                } else {
                    nextId = counterDoc.data().current_value + 1;
                    transaction.update(counterRef, { current_value: nextId });
                }
            });
            return nextId;
        }

        // --- CLIENT CENTRAL LOGIC ---
        addClientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const { 'client-name': name, 'client-contact': contact, 'client-email': email, 'client-status': status } = addClientForm.elements;
            try {
                const nextId = await getNextSequenceValue("client");
                const clientData = {
                    clientId: `CL-${nextId}`,
                    name: name.value,
                    contact: contact.value,
                    email: email.value,
                    status: status.value,
                };
                await addDoc(collection(db, "clients"), clientData);
                addClientForm.reset();
            } catch (error) { alert("Error adding client: " + error.message); }
        });

        function listenForClients() {
            onSnapshot(collection(db, "clients"), (snapshot) => {
                clientList.innerHTML = '';
                snapshot.forEach((doc) => {
                    const client = { id: doc.id, ...doc.data() };
                    const clientCard = document.createElement('div');
                    clientCard.className = 'bg-gray-700 p-3 rounded-lg cursor-pointer hover:bg-gray-600';
                    clientCard.innerHTML = `<div class="flex justify-between items-start"><h4 class="font-bold text-lg">${client.name}</h4><span class="text-xs font-mono text-gray-400">${client.clientId || 'N/A'}</span></div><p class="text-sm text-gray-300 mt-1">${client.contact} (${client.email})</p><p class="text-xs font-semibold mt-2 inline-block py-1 px-2 rounded-full bg-blue-500">${client.status}</p>`;
                    clientCard.addEventListener('click', () => openEditClientModal(client));
                    clientList.appendChild(clientCard);
                });
            });
        }

        function openEditClientModal(client) {
            editClientForm['edit-client-id'].value = client.id;
            editClientForm['edit-client-name'].value = client.name;
            editClientForm['edit-client-contact'].value = client.contact;
            editClientForm['edit-client-email'].value = client.email;
            editClientForm['edit-client-status'].value = client.status;
            modalClientId.textContent = `Client ID: ${client.clientId || 'N/A'}`;
            editClientModal.classList.remove('hidden');
            editClientModal.classList.add('flex');
        }
        closeEditClientModalBtn.addEventListener('click', () => { editClientModal.classList.add('hidden'); editClientModal.classList.remove('flex'); });

        editClientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const { 'edit-client-id': id, 'edit-client-name': name, 'edit-client-contact': contact, 'edit-client-email': email, 'edit-client-status': status } = editClientForm.elements;
            try {
                await updateDoc(doc(db, "clients", id.value), { name: name.value, contact: contact.value, email: email.value, status: status.value });
                closeEditClientModalBtn.click();
            } catch (error) { alert("Error updating client: " + error.message); }
        });
        
        deleteClientBtn.addEventListener('click', async () => {
            const clientId = editClientForm['edit-client-id'].value;
            if (confirm("Are you sure you want to delete this client?")) {
                try {
                    await deleteDoc(doc(db, "clients", clientId));
                    closeEditClientModalBtn.click();
                } catch (error) { alert("Error deleting client: " + error.message); }
            }
        });

        // --- INVENTORY LOGIC ---
        addItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const { 'item-name': name, 'item-category': category, 'item-quantity': quantity, 'item-status': status } = addItemForm.elements;
            try {
                const nextId = await getNextSequenceValue("inventory");
                const itemData = {
                    itemId: `INV-${nextId}`,
                    name: name.value,
                    category: category.value,
                    quantity: Number(quantity.value),
                    status: status.value
                };
                await addDoc(collection(db, "inventory"), itemData);
                addItemForm.reset();
            } catch (error) { alert("Error adding item: " + error.message); }
        });

        function listenForInventory() {
            onSnapshot(collection(db, "inventory"), (snapshot) => {
                inventoryList.innerHTML = '';
                snapshot.forEach((doc) => {
                    const item = { id: doc.id, ...doc.data() };
                    const itemCard = document.createElement('div');
                    itemCard.className = 'bg-gray-700 p-3 rounded-lg cursor-pointer hover:bg-gray-600';
                    itemCard.innerHTML = `<div class="flex justify-between items-start"><h4 class="font-bold text-lg">${item.name}</h4><span class="text-xs font-mono text-gray-400">${item.itemId || 'N/A'}</span></div><p class="text-sm text-gray-300 mt-1">Category: ${item.category}</p><p class="text-sm text-gray-300">Quantity: ${item.quantity}</p><p class="text-xs font-semibold mt-2 inline-block py-1 px-2 rounded-full bg-purple-500">${item.status}</p>`;
                    itemCard.addEventListener('click', () => openEditItemModal(item));
                    inventoryList.appendChild(itemCard);
                });
            });
        }

        function openEditItemModal(item) {
            editItemForm['edit-item-id'].value = item.id;
            editItemForm['edit-item-name'].value = item.name;
            editItemForm['edit-item-category'].value = item.category;
            editItemForm['edit-item-quantity'].value = item.quantity;
            editItemForm['edit-item-status'].value = item.status;
            modalItemId.textContent = `Item ID: ${item.itemId || 'N/A'}`;
            editItemModal.classList.remove('hidden');
            editItemModal.classList.add('flex');
        }
        closeEditItemModalBtn.addEventListener('click', () => { editItemModal.classList.add('hidden'); editItemModal.classList.remove('flex'); });

        editItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const { 'edit-item-id': id, 'edit-item-name': name, 'edit-item-category': category, 'edit-item-quantity': quantity, 'edit-item-status': status } = editItemForm.elements;
            try {
                await updateDoc(doc(db, "inventory", id.value), { name: name.value, category: category.value, quantity: Number(quantity.value), status: status.value });
                closeEditItemModalBtn.click();
            } catch (error) { alert("Error updating item: " + error.message); }
        });

        deleteItemBtn.addEventListener('click', async () => {
            const itemId = editItemForm['edit-item-id'].value;
            if (confirm("Are you sure you want to delete this item?")) {
                try {
                    await deleteDoc(doc(db, "inventory", itemId));
                    closeEditItemModalBtn.click();
                } catch (error) { alert("Error deleting item: " + error.message); }
            }
        });

        // --- NAVIGATION ---
        mainNav.addEventListener('click', (e) => {
            if (e.target.classList.contains('nav-link')) {
                e.preventDefault();
                const viewId = e.target.dataset.view;
                document.querySelectorAll('.module-view').forEach(v => v.classList.add('hidden-view'));
                document.getElementById(viewId).classList.remove('hidden-view');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active-nav'));
                e.target.classList.add('active-nav');
            }
        });
        
        document.querySelectorAll('.module-card').forEach(card => {
            card.addEventListener('click', (e) => {
                const viewId = e.currentTarget.dataset.view;
                if(viewId) document.querySelector(`.nav-link[data-view="${viewId}"]`).click();
            });
        });
    </script>
</body>
</html>
